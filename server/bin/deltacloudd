#!/bin/env ruby

require 'rubygems'
require 'optparse'
require 'thin'

options = {
  :env => 'development',
  :host => 'localhost',
  :port => '3000'
}
optparse = OptionParser.new do |opts|

opts.banner = <<BANNER
Usage:
deltacloudd -i <driver> [options]

Options:
BANNER
  opts.on( '-i', '--driver DRIVER', 'Driver to use') { |driver| options[:driver] = driver }
  opts.on( '-r', '--hostname HOSTNAME', 'Bind to HOST address (default: localhost)') { |host| options[:host] = host }
  opts.on( '-p', '--port PORT', 'Use PORT (default: 3000)') { |port| options[:port] = port }
  opts.on( '-e', '--env ENV', 'Environment (default: "development")') { |env| options[:env] = env }
end

optparse.parse!

unless options[:driver]
  puts "You need to specify a driver to use (-i <driver>)"
  exit(1)
end

dirname="#{File.dirname(__FILE__)}/.."

argv_opts = ARGV.clone
argv_opts << ['start'] unless Thin::Runner.commands.include?(options[0])
argv_opts << ['--address', options[:host] ]
argv_opts << ['--port', options[:port] ]
argv_opts << ['--rackup', 'config.ru' ]
argv_opts << ['--chdir', dirname ]
argv_opts << ['-e', options[:env] ]
argv_opts << ['--threaded', '-D', '--stats', '/stats']

argv_opts.flatten!

thin = Thin::Runner.new(argv_opts)

begin
  puts "Starting Deltacloud API :: #{options[:driver]} :: http://#{options[:host]}:#{options[:port]}/api"
  puts
  thin.run!
rescue Exception => e
  puts "ERROR: #{e.message}"
end

